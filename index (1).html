<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生理韌性跑步分析平台</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2962ff;
            --accent: #00bfae;
            --bg: #f9fafc;
            --card: #fff;
            --text-main: #222;
            --text-secondary: #668;
            --border: #e0e5eb;
            --shadow: 0 4px 16px rgba(41, 98, 255, 0.05);
            --radius: 14px;
        }
        html, body {
            background: var(--bg);
            color: var(--text-main);
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 880px;
            margin: 32px auto;
            padding: 16px;
        }
        header {
            text-align: center;
            margin-bottom: 32px;
        }
        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }
        header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 28px 28px 20px 28px;
            margin-bottom: 32px;
        }
        .card h2 {
            margin-top: 0;
            font-size: 1.35rem;
            color: var(--primary);
            margin-bottom: 18px;
        }
        table.data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px;
        }
        table.data-table th, table.data-table td {
            text-align: center;
            padding: 10px 8px;
        }
        table.data-table th {
            background: var(--bg);
            color: var(--primary);
            font-weight: 700;
            border-bottom: 2px solid var(--border);
        }
        table.data-table tr:not(:last-child) td {
            border-bottom: 1px solid var(--border);
        }
        table.data-table input[type="number"], table.data-table input[type="date"] {
            width: 95%;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            background: #f6f8fa;
        }
        .btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 8px 20px;
            border-radius: 100px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 700;
            margin: 0 2px;
            box-shadow: 0 2px 6px rgba(41,98,255, 0.04);
            transition: background .2s;
        }
        .btn.secondary {
            background: var(--accent);
        }
        .btn.danger {
            background: #ff5252;
        }
        .btn:active {
            background: #0039cb;
        }
        .flex-row {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .result-box {
            margin-top: 10px;
            padding: 20px 16px;
            background: #f1f5fc;
            border-radius: var(--radius);
            color: var(--text-main);
        }
        .tag {
            display: inline-block;
            border-radius: 100px;
            background: var(--primary);
            color: #fff;
            font-size: 0.9rem;
            padding: 2px 14px;
            margin-left: 6px;
            font-weight: 700;
        }
        footer {
            text-align: center;
            color: #aab;
            padding: 32px 0 10px 0;
            font-size: 0.95rem;
        }
        .chart-container {
            height: 320px;
            margin-top: 24px;
        }
        @media (max-width: 600px) {
            .container { padding: 4px;}
            .card { padding: 10px 4px 10px 4px;}
            .chart-container { height: 210px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>生理韌性跑步分析平台</h1>
            <p>輸入您的跑步資料，立即獲得個人化數據分析與訓練建議</p>
        </header>
        <div class="card">
            <h2>跑步數據輸入</h2>
            <form id="run-form" onsubmit="return false;">
                <table class="data-table" id="input-table">
                    <thead>
                        <tr>
                            <th>距離 (公里)</th>
                            <th>用時 (分鐘)</th>
                            <th>日期</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="data-rows"></tbody>
                </table>
                <button class="btn secondary" id="add-row">新增紀錄</button>
                <button class="btn" id="analyze-btn" type="button">分析</button>
            </form>
        </div>
        <div class="card" id="result-card" style="display:none;">
            <h2>分析結果</h2>
            <div class="flex-row">
                <div>
                    <div>疲勞因子 <span class="tag">SDI</span>：<b id="sdi-value"></b></div>
                    <div>生理韌性等級：<b id="resilience-level"></b></div>
                    <div id="resilience-desc" style="color:#668;margin-bottom:8px;"></div>
                </div>
                <div>
                    <div>5公里預測：<b id="pred-5k"></b></div>
                    <div>10公里預測：<b id="pred-10k"></b></div>
                    <div>半馬預測：<b id="pred-half"></b></div>
                    <div>全馬預測：<b id="pred-full"></b></div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="performance-chart"></canvas>
            </div>
            <div class="result-box" id="train-box"></div>
        </div>
        <footer>
            基於Jones (2024) 生理韌性模型 | Riegel (1981) 預測模型<br>
            &copy; 2025 生理韌性分析平台
        </footer>
    </div>
    <script>
        function addRow(distance='', time='', date='') {
            if (distance <= 0 || time <= 0) {
                alert("距離和用時必須為正數！");
                return;
            }
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="number" min="0.1" step="0.1" value="${distance}" required></td>
                <td><input type="number" min="1" step="0.1" value="${time}" required></td>
                <td><input type="date" value="${date||new Date().toISOString().split('T')[0]}" required></td>
                <td><button class="btn danger" type="button" onclick="this.closest('tr').remove()">刪除</button></td>
            `;
            document.getElementById('data-rows').appendChild(tr);
        }
        document.getElementById('add-row').onclick = () => addRow();
        addRow(5, 25);

        function fmtTime(mins) {
            mins = Math.max(0, mins);
            const h = Math.floor(mins / 60);
            const m = Math.floor(mins % 60);
            const s = Math.round((mins - Math.floor(mins)) * 60);
            return h > 0 ? `${h}小時${m}分${s}秒` : `${m}分${s}秒`;
        }
        function riegel(t1, d1, d2, sdi) {
            const exponent = sdi <= 1.07 ? 1.06 : sdi; // 動態調整指數
            return t1 * Math.pow(d2 / d1, exponent);
        }
        function calcSDI(records) {
            const speeds = records.map(r => r.distance / r.time).filter(s => !isNaN(s) && s > 0);
            if (speeds.length < 2) {
                alert("請至少輸入兩筆以上數據以計算疲勞因子！");
                return 'N/A';
            }
            const avg = speeds.reduce((a, b) => a + b, 0) / speeds.length;
            const std = Math.sqrt(speeds.reduce((sum, s) => sum + Math.pow(s - avg, 2), 0) / speeds.length);

            // 篩選出不超出標準差範圍的速度值
            const filteredSpeeds = speeds.filter(s => Math.abs(s - avg) <= std);
            const filteredAvg = filteredSpeeds.reduce((a, b) => a + b, 0) / filteredSpeeds.length;
            const filteredStd = Math.sqrt(filteredSpeeds.reduce((sum, s) => sum + Math.pow(s - filteredAvg, 2), 0) / filteredSpeeds.length);
            return (filteredStd / filteredAvg).toFixed(3);
        }
        function getLevel(sdi) {
            sdi = parseFloat(sdi);
            if (isNaN(sdi)) return {level: "無法評估", desc: "請檢查輸入數據是否正確"};
            if (sdi < 0.03) return {level: "精英", desc: "表現極為穩定，建議挑戰更高目標"};
            if (sdi < 0.06) return {level: "優秀", desc: "表現穩定，可適度增加強度"};
            if (sdi < 0.09) return {level: "良好", desc: "穩定中等，有提升空間"};
            return {level: "待加強", desc: "建議提升穩定性與基本耐力"};
        }
        function getTrainSuggestion(basePace, sdi) {
            if (basePace <= 0 || sdi <= 0) {
                return "<b>配速建議無法計算，請檢查數據輸入。</b>";
            }
            const vt2 = basePace * (1 + (sdi - 1.07) * 0.05 + 0.22); // 動態調整 VT2
            const vt1 = basePace * (1 + (sdi - 1.07) * 0.05 + 0.31); // 動態調整 VT1
            return `
                <b>配速訓練區間：</b><br>
                高強度 (≥VT2)：${vt2.toFixed(2)}/km<br>
                中等強度 (VT1~VT2)：${vt1.toFixed(2)}~${vt2.toFixed(2)}/km<br>
                低強度 (<VT1)：慢於${vt1.toFixed(2)}/km<br>
            `;
        }
        document.getElementById('analyze-btn').onclick = function() {
            const trs = Array.from(document.querySelectorAll('#data-rows tr'));
            const records = trs.map(tr => ({
                distance: parseFloat(tr.querySelectorAll('input')[0].value),
                time: parseFloat(tr.querySelectorAll('input')[1].value)
            })).filter(r => r.distance > 0 && r.time > 0);

            if (!records.length) { 
                alert("請至少輸入一筆有效數據！"); 
                return; 
            }

            const sdi = calcSDI(records);
            if (parseFloat(sdi) > 1.07) {
                alert(`注意：您的疲勞因子 (SDI=${sdi}) 超過 1.07，可能影響配速建議範圍！`);
            }
            const lev = getLevel(sdi);

            document.getElementById('sdi-value').textContent = sdi;
            document.getElementById('resilience-level').textContent = lev.level;
            document.getElementById('resilience-desc').textContent = lev.desc;

            const base = records.reduce((best, current) => {
                const bestSpeed = best.distance / best.time;
                const currentSpeed = current.distance / current.time;
                return Math.abs(currentSpeed - bestSpeed) < Math.abs(bestSpeed - bestSpeed) ? current : best;
            });

            document.getElementById('pred-5k').textContent = fmtTime(riegel(base.time, base.distance, 5, parseFloat(sdi)));
            document.getElementById('pred-10k').textContent = fmtTime(riegel(base.time, base.distance, 10, parseFloat(sdi)));
            document.getElementById('pred-half').textContent = fmtTime(riegel(base.time, base.distance, 21.0975, parseFloat(sdi)));
            document.getElementById('pred-full').textContent = fmtTime(riegel(base.time, base.distance, 42.195, parseFloat(sdi)));

            const pace = base.time / base.distance;
            document.getElementById('train-box').innerHTML = getTrainSuggestion(pace, parseFloat(sdi));

            const labels = ['5K', '10K', '半馬', '全馬'];
            const perfData = [
                riegel(base.time, base.distance, 5, parseFloat(sdi)),
                riegel(base.time, base.distance, 10, parseFloat(sdi)),
                riegel(base.time, base.distance, 21.0975, parseFloat(sdi)),
                riegel(base.time, base.distance, 42.195, parseFloat(sdi))
            ].filter(x => x > 0 && x < 360); // 限制合理範圍（例如 360 分鐘內）
            if (window.perfChart) window.perfChart.destroy();
            window.perfChart = new Chart(document.getElementById('performance-chart').getContext('2d'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: '預測時間 (分鐘)',
                        data: perfData.map(x => +x.toFixed(1)),
                        borderColor: "#2962ff", backgroundColor: 'rgba(41,98,255,0.13)',
                        pointBackgroundColor: "#00bfae", borderWidth: 3, pointRadius: 5, tension: 0.21, fill: true
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: '分鐘' }, grid: { color: '#e1e6f5' } },
                        x: { title: { display: true, text: '距離' }, grid: { color: '#e1e6f5' } }
                    }
                }
            });
            document.getElementById('result-card').style.display = '';
            window.scrollTo({ 
                top: document.getElementById('result-card').offsetTop - 30, 
                behavior: 'smooth' 
            });
        }
    </script>
</body>
</html>
        }
    </script>
</body>
</html>
